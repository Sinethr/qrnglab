class QuantumDiceTool{constructor(e){this.container=document.getElementById(e),this.cache=[],this.rollHistory=[],this.init()}init(){const e="dice-custom-styles";if(!document.getElementById(e)){const t=document.createElement("style");t.id=e,t.textContent='\n            .die-face-d6 {\n                display: grid;\n                grid-template-areas: \n                    "a . c"\n                    "e g f"\n                    "d . b";\n                padding: 4px; /* Reduced padding */\n            }\n            .pip { display: none; background-color: #1f2937; border-radius: 50%; width: 10px; height: 10px; place-self: center; box-shadow: inset 0 1px 1px rgba(0,0,0,0.5); }\n            .die-face-d6[data-val="1"] .pip:nth-child(7) { display: block; grid-area: g; width: 14px; height: 14px; background-color: #db2716; } /* Center red dot */\n            \n            .die-face-d6[data-val="2"] .pip:nth-child(1) { display: block; grid-area: a; }\n            .die-face-d6[data-val="2"] .pip:nth-child(2) { display: block; grid-area: b; }\n            \n            .die-face-d6[data-val="3"] .pip:nth-child(1) { display: block; grid-area: a; }\n            .die-face-d6[data-val="3"] .pip:nth-child(7) { display: block; grid-area: g; }\n            .die-face-d6[data-val="3"] .pip:nth-child(2) { display: block; grid-area: b; }\n\n            .die-face-d6[data-val="4"] .pip:nth-child(1) { display: block; grid-area: a; }\n            .die-face-d6[data-val="4"] .pip:nth-child(3) { display: block; grid-area: c; }\n            .die-face-d6[data-val="4"] .pip:nth-child(4) { display: block; grid-area: d; }\n            .die-face-d6[data-val="4"] .pip:nth-child(2) { display: block; grid-area: b; }\n\n            .die-face-d6[data-val="5"] .pip:nth-child(1) { display: block; grid-area: a; }\n            .die-face-d6[data-val="5"] .pip:nth-child(3) { display: block; grid-area: c; }\n            .die-face-d6[data-val="5"] .pip:nth-child(7) { display: block; grid-area: g; }\n            .die-face-d6[data-val="5"] .pip:nth-child(4) { display: block; grid-area: d; }\n            .die-face-d6[data-val="5"] .pip:nth-child(2) { display: block; grid-area: b; }\n\n            .die-face-d6[data-val="6"] .pip:nth-child(1) { display: block; grid-area: a; }\n            .die-face-d6[data-val="6"] .pip:nth-child(3) { display: block; grid-area: c; }\n            .die-face-d6[data-val="6"] .pip:nth-child(5) { display: block; grid-area: e; }\n            .die-face-d6[data-val="6"] .pip:nth-child(6) { display: block; grid-area: f; }\n            .die-face-d6[data-val="6"] .pip:nth-child(4) { display: block; grid-area: d; }\n            .die-face-d6[data-val="6"] .pip:nth-child(2) { display: block; grid-area: b; }\n\n            @keyframes rollIn {\n                0% { transform: rotateX(720deg) rotateY(360deg) scale(0.5); opacity: 0; }\n                80% { transform: scale(1.1); }\n                100% { transform: rotateX(0) rotateY(0) scale(1); opacity: 1; }\n            }\n        ',document.head.appendChild(t)}this.container.innerHTML='\n      <div class="bg-white rounded-2xl p-6 md:p-8 max-w-4xl mx-auto shadow-sm border border-gray-100">\n        \x3c!-- Header --\x3e\n        <div class="text-center mb-8">\n          <h2 class="text-2xl font-bold text-gray-800 mb-2">üé≤ Quantum Dice Roller</h2>\n          <p class="text-gray-600">Roll dice with quantum randomness - perfect for games and fair decisions</p>\n        </div>\n        \n        \x3c!-- Controls --\x3e\n        <div class="bg-gray-50 p-6 rounded-xl border border-gray-100 mb-8">\n          <div class="grid grid-cols-1 md:grid-cols-12 gap-6 mb-6">\n            \x3c!-- Preset Selection --\x3e\n            <div class="md:col-span-4">\n              <label for="dice-preset" class="block text-sm font-bold text-gray-700 mb-1">Preset</label>\n              <div class="relative">\n                <select id="dice-preset" class="w-full pl-4 pr-10 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all shadow-sm bg-white text-gray-800 appearance-none">\n                    <option value="d6" selected>1d6 (Standard Die)</option>\n                    <option value="2d6">2d6 (Board Games)</option>\n                    <option value="3d6">3d6 (Stats)</option>\n                    <option value="d20">1d20 (D&D / RPG)</option>\n                    <option value="d100">1d100 (Percentile)</option>\n                    <option value="custom">Custom Configuration...</option>\n                </select>\n                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">\n                  <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>\n                </div>\n              </div>\n            </div>\n            \n            \x3c!-- Custom Controls (Hidden by default) --\x3e\n            <div id="custom-controls" class="hidden md:col-span-8 grid grid-cols-2 gap-4">\n               <div>\n                <label for="dice-sides" class="block text-sm font-bold text-gray-700 mb-1">Sides</label>\n                <input type="number" id="dice-sides" value="6" min="2" max="1000"\n                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none shadow-sm font-mono text-center">\n               </div>\n               <div>\n                <label for="dice-count" class="block text-sm font-bold text-gray-700 mb-1">Count</label>\n                <input type="number" id="dice-count" value="1" min="1" max="10"\n                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none shadow-sm font-mono text-center">\n               </div>\n            </div>\n\n            \x3c!-- Standard Count Display (Only for presets, readonly-ish feel) --\x3e\n            <div id="standard-info" class="md:col-span-8 flex items-center text-gray-500 text-sm italic">\n                Select \'Custom\' to change sides and count manually.\n            </div>\n          </div>\n          \n          <div class="flex flex-col sm:flex-row gap-6 items-center justify-between border-t border-gray-200 pt-6">\n            <div class="flex flex-col sm:flex-row gap-4">\n                <label class="flex items-center gap-2 cursor-pointer">\n                    <input type="checkbox" id="show-individual" checked class="w-5 h-5 text-emerald-600 rounded border-gray-300 focus:ring-emerald-500 transition duration-150 ease-in-out" />\n                    <span class="text-gray-700 text-sm font-medium">Show details</span>\n                </label>\n                \n                <label class="flex items-center gap-2 cursor-pointer">\n                    <input type="checkbox" id="auto-sum" checked class="w-5 h-5 text-emerald-600 rounded border-gray-300 focus:ring-emerald-500 transition duration-150 ease-in-out" />\n                    <span class="text-gray-700 text-sm font-medium">Sum total</span>\n                </label>\n            </div>\n            \n            <button id="roll-dice" class="w-full sm:w-auto bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:shadow-xl transition-all transform active:scale-[0.98] flex items-center justify-center gap-2">\n                <span class="text-xl">üé≤</span>\n                <span>ROLL DICE</span>\n            </button>\n          </div>\n        </div>\n        \n        \x3c!-- Display Area --\x3e\n        <div class="min-h-[200px] flex flex-col items-center justify-center mb-8 relative">\n           \x3c!-- Loading --\x3e\n           <div id="dice-loading" class="hidden absolute inset-0 bg-white/80 z-20 flex flex-col items-center justify-center rounded-xl backdrop-blur-sm">\n             <div class="animate-spin rounded-full h-10 w-10 border-4 border-emerald-200 border-t-emerald-600 mb-3"></div>\n             <p class="text-emerald-800 font-medium animate-pulse">Rolling quantum dice...</p>\n           </div>\n\n           \x3c!-- Dice Container --\x3e\n           <div id="dice-animation" class="flex flex-wrap justify-center gap-6 p-4 perspective-1000">\n             \x3c!-- Animated dice injected here --\x3e\n             <div class="text-gray-400 text-center italic">\n                Ready to roll.\n             </div>\n           </div>\n           \n           \x3c!-- Text Result --\x3e\n           <div id="dice-result" class="hidden mt-8 text-center w-full animate-fade-in-up">\n              <div class="mb-2">\n                <span id="result-value" class="text-5xl font-black text-gray-800 tracking-tight"></span>\n              </div>\n              <div id="result-label" class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-4"></div>\n              \n              <div id="individual-rolls" class="flex flex-wrap justify-center gap-2 max-w-lg mx-auto p-4 bg-gray-50 rounded-xl border border-dashed border-gray-200 text-gray-600 font-mono text-sm leading-relaxed">\n              </div>\n           </div>\n\n           \x3c!-- Error --\x3e\n           <div id="dice-error" class="hidden mt-4 p-4 bg-red-50 text-red-600 rounded-xl border border-red-100 flex items-center gap-3">\n              <span class="text-xl">‚ö†Ô∏è</span>\n              <span id="dice-error-message"></span>\n           </div>\n        </div>\n        \n        \x3c!-- History --\x3e\n        <div id="dice-history" class="border-t border-gray-100 pt-6">\n          <div class="flex justify-between items-center mb-4">\n            <h3 class="text-lg font-bold text-gray-800">Roll History</h3>\n            <div class="flex gap-2">\n                <button id="export-dice-history" class="text-xs font-medium text-emerald-600 hover:text-emerald-800 hover:bg-emerald-50 px-3 py-1 rounded-md transition-colors hidden">\n                    Export\n                </button>\n                <button id="clear-dice-history" class="text-xs font-medium text-gray-500 hover:text-red-600 hover:bg-red-50 px-3 py-1 rounded-md transition-colors">\n                    Clear\n                </button>\n            </div>\n          </div>\n          \n          <div class="space-y-2 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar" id="history-list">\n             <div class="text-center py-8 text-gray-400 bg-gray-50 rounded-xl border border-dashed border-gray-200 italic text-sm">\n                Your lucky rolls will appear here\n             </div>\n          </div>\n        </div>\n      </div>\n    ',this.bindEvents(),this.updateControlsForPreset(),this.preloadQuantumCache()}bindEvents(){const e=this.container.querySelector("#roll-dice"),t=this.container.querySelector("#dice-preset"),i=this.container.querySelector("#clear-dice-history"),n=this.container.querySelector("#export-dice-history");e.addEventListener("click",()=>this.rollDice()),t.addEventListener("change",()=>this.updateControlsForPreset()),i.addEventListener("click",()=>this.clearHistory()),n.addEventListener("click",()=>this.exportHistory()),this.container.querySelectorAll("input").forEach(e=>{e.addEventListener("keypress",e=>{"Enter"===e.key&&this.rollDice()})})}updateControlsForPreset(){const e=this.container.querySelector("#dice-preset").value,t=this.container.querySelector("#custom-controls"),i=this.container.querySelector("#standard-info"),n=this.container.querySelector("#dice-sides"),d=this.container.querySelector("#dice-count"),r={d6:{sides:6,count:1},"2d6":{sides:6,count:2},"3d6":{sides:6,count:3},d20:{sides:20,count:1},d100:{sides:100,count:1}};if("custom"===e)t.classList.remove("hidden"),t.classList.add("grid"),i.classList.add("hidden");else{t.classList.add("hidden"),t.classList.remove("grid"),i.classList.remove("hidden");const a=r[e];a&&(n.value=a.sides,d.value=a.count)}}async preloadQuantumCache(){try{this.cache=await qrngService.getUint16(50)}catch(e){console.warn("Failed to preload quantum cache:",e)}}async rollDice(){const e=parseInt(this.container.querySelector("#dice-sides").value),t=parseInt(this.container.querySelector("#dice-count").value);if(this.container.querySelector("#dice-error").classList.add("hidden"),isNaN(e)||e<2||e>1e3)this.showError("Number of sides must be between 2 and 1000");else if(isNaN(t)||t<1||t>10)this.showError("Number of dice must be between 1 and 10");else{this.showLoading();try{let i;this.cache.length>=t?(i=this.cache.splice(0,t),this.preloadQuantumCache()):i=await qrngService.getUint16(t);const n=i.map(t=>1+t%e),d=n.reduce((e,t)=>e+t,0);await this.animateDiceRoll(n,e),this.showResults(n,d,e),this.addToHistory({rolls:n,sum:d,sides:e,count:t,timestamp:new Date}),this.hideLoading(),window.qrngService&&qrngService.emit("tool_usage",{tool:"dice",sides:e,count:t,rolls:n,sum:d})}catch(e){console.error("Dice roll error:",e),this.showError(`Failed to roll dice: ${e.message}`)}}}async animateDiceRoll(e,t){const i=this.container.querySelector("#dice-animation");this.container.querySelector("#dice-result").classList.add("hidden"),i.innerHTML="",e.forEach((e,n)=>{const d=document.createElement("div");d.style.animation=`rollIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) ${.1*n}s forwards`,d.style.opacity="0",d.innerHTML=this.renderDieHTML(e,t),i.appendChild(d)}),await new Promise(t=>setTimeout(t,1e3+100*e.length))}renderDieHTML(e,t){return 6===t?`\n            <div class="die-face-d6 w-20 h-20 bg-white rounded-xl shadow-lg border-2 border-slate-200 flex-shrink-0" data-val="${e}">\n                <div class="pip"></div><div class="pip"></div><div class="pip"></div>\n                <div class="pip"></div><div class="pip"></div><div class="pip"></div>\n                <div class="pip"></div>\n            </div>\n          `:`\n        <div class="w-20 h-20 flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl shadow-lg border-2 border-indigo-300 text-white font-bold text-2xl flex-shrink-0 relative overflow-hidden">\n             <div class="absolute inset-0 bg-white opacity-10 rounded-full transform scale-150 translate-x-10 -translate-y-10"></div>\n             <span class="relative z-10 drop-shadow-md">${e}</span>\n             <span class="absolute bottom-1 right-2 text-[10px] uppercase opacity-50 font-normal tracking-wider">d${t}</span>\n        </div>\n      `}showResults(e,t,i){const n=this.container.querySelector("#dice-result"),d=this.container.querySelector("#result-value"),r=this.container.querySelector("#result-label"),a=this.container.querySelector("#individual-rolls"),s=this.container.querySelector("#show-individual").checked,o=this.container.querySelector("#auto-sum").checked;if(1===e.length?(d.textContent=e[0],r.textContent=`Result (d${i})`):o?(d.textContent=t,r.textContent=`Total Sum (${e.length}d${i})`):(d.textContent=e.join(", "),r.textContent=`Rolled ${e.length}d${i}`),s&&e.length>1){if(a.innerHTML=e.map((t,i)=>`<span class="inline-block px-2 py-1 bg-white border border-gray-200 rounded shadow-sm font-bold text-gray-700">${t}</span>${i<e.length-1?'<span class="text-gray-300">+</span>':""}`).join(" "),o){const t=`( ${e.join(" + ")} )`;a.innerHTML=t}a.classList.remove("hidden")}else a.classList.add("hidden");n.classList.remove("hidden")}addToHistory(e){this.rollHistory.unshift(e),this.rollHistory.length>20&&(this.rollHistory=this.rollHistory.slice(0,20)),this.updateHistoryDisplay()}updateHistoryDisplay(){const e=this.container.querySelector("#history-list"),t=this.container.querySelector("#export-dice-history");if(0===this.rollHistory.length)return e.innerHTML='<div class="text-center py-8 text-gray-400 bg-gray-50 rounded-xl border border-dashed border-gray-200 italic text-sm">Your lucky rolls will appear here</div>',void t.classList.add("hidden");t.classList.remove("hidden"),e.innerHTML=this.rollHistory.map((e,t)=>{const i=this.getTimeAgo(e.timestamp);let n="",d="";if(1===e.count)n=e.rolls[0],d=`${e.sides}-sided die`;else{n=e.sum;const t=e.rolls.join(" + ");d=t.length>20?`${e.count}d${e.sides} (${t.substring(0,20)}...)`:`${e.count}d${e.sides} (${t})`}return`\n        <div class="flex items-center justify-between p-3 bg-white hover:bg-gray-50 border border-gray-100 rounded-lg transition-colors group">\n          <div class="flex items-center gap-4 min-w-0">\n            <div class="w-10 h-10 rounded-full bg-emerald-100 text-emerald-700 flex items-center justify-center font-bold text-lg flex-shrink-0 group-hover:scale-110 transition-transform">\n                ${1===e.count&&6===e.sides?this.getD6Unicode(e.rolls[0]):"#"}\n            </div>\n            <div class="flex flex-col min-w-0">\n                <div class="font-bold text-gray-800 text-lg leading-tight truncate" title="${e.count>1?e.rolls.join(" + "):""}">\n                    ${n}\n                </div>\n                <div class="text-xs text-gray-500 truncate font-mono">\n                    ${d}\n                </div>\n            </div>\n          </div>\n          <div class="text-xs text-gray-400 whitespace-nowrap ml-4 font-medium">\n            ${i}\n          </div>\n        </div>\n      `}).join("")}getD6Unicode(e){return["‚öÄ","‚öÅ","‚öÇ","‚öÉ","‚öÑ","‚öÖ"][e-1]||e}getTimeAgo(e){const t=Math.floor((new Date-e)/1e3);return t<60?`${t}s`:t<3600?`${Math.floor(t/60)}m`:`${Math.floor(t/3600)}h`}clearHistory(){this.rollHistory=[],this.updateHistoryDisplay()}exportHistory(){const e=`Quantum Dice Roll History\nGenerated: ${(new Date).toLocaleString()}\n\n`+this.rollHistory.map((e,t)=>`${this.rollHistory.length-t}. ${1===e.count?e.rolls[0]:`${e.sum} (${e.rolls.join("+")})`} [${e.count}d${e.sides}]`).join("\n"),t=new Blob([e],{type:"text/plain"}),i=URL.createObjectURL(t),n=document.createElement("a");n.href=i,n.download="quantum-dice-history.txt",n.click(),URL.revokeObjectURL(i)}showLoading(){this.container.querySelector("#dice-loading").classList.remove("hidden"),this.container.querySelector("#dice-error").classList.add("hidden"),this.container.querySelector("#roll-dice").disabled=!0}hideLoading(){this.container.querySelector("#dice-loading").classList.add("hidden"),this.container.querySelector("#roll-dice").disabled=!1}showError(e){this.container.querySelector("#dice-error-message").textContent=e,this.container.querySelector("#dice-error").classList.remove("hidden"),this.container.querySelector("#dice-loading").classList.add("hidden"),this.container.querySelector("#roll-dice").disabled=!1}}window.QuantumDiceTool=QuantumDiceTool;