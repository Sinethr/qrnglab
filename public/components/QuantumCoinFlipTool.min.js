class QuantumCoinFlipTool{constructor(t){this.container=document.getElementById(t),this.history=[],this.maxHistory=10,this.currentRotation=0,this.init()}init(){const t="coin-flip-3d-styles";if(!document.getElementById(t)){const e=document.createElement("style");e.id=t,e.textContent="\n            .perspective-1000 { perspective: 1000px; }\n            .transform-style-3d { transform-style: preserve-3d; }\n            .backface-hidden { backface-visibility: hidden; }\n            .rotate-y-180 { transform: rotateY(180deg); }\n        ",document.head.appendChild(e)}this.container.innerHTML='\n        <div class="bg-white rounded-2xl p-6 md:p-8 max-w-3xl mx-auto shadow-sm border border-gray-100">\n            \x3c!-- Header --\x3e\n            <div class="text-center mb-8">\n                <h3 class="text-2xl font-bold text-gray-800 mb-2">ü™ô Quantum Coin Flip</h3>\n                <p class="text-gray-600">Fair coin flips using quantum randomness</p>\n            </div>\n\n            <div class="space-y-6">\n                \x3c!-- Controls --\x3e\n                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-gray-50 p-4 rounded-xl">\n                    <div>\n                        <label for="coin-count" class="block text-sm font-semibold text-gray-700 mb-2">Number of Flips</label>\n                        <div class="flex items-center gap-2">\n                             <button id="decrease-count" class="flex-shrink-0 w-12 h-12 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold text-2xl flex items-center justify-center transition-colors border border-gray-200 active:scale-95 touch-manipulation select-none">-</button>\n                             <div class="relative flex-1">\n                                 <input type="number" id="coin-count"  \n                                     class="w-full h-12 px-4 border border-gray-300 rounded-xl text-center font-bold text-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all shadow-sm bg-white"\n                                     placeholder="Max 20" />\n                             </div>\n                             <button id="increase-count" class="flex-shrink-0 w-12 h-12 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold text-2xl flex items-center justify-center transition-colors border border-gray-200 active:scale-95 touch-manipulation select-none">+</button>\n                        </div>\n                    </div>\n                    \n                    <div>\n                        <label for="coin-speed" class="block text-sm font-semibold text-gray-700 mb-2">Animation Speed</label>\n                        <select id="coin-speed" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all bg-white shadow-sm">\n                            <option value="fast">Fast ‚ö°</option>\n                            <option value="normal" selected>Normal üéØ</option>\n                            <option value="slow">Slow üê¢</option>\n                        </select>\n                    </div>\n                </div>\n                \n                \x3c!-- Action Buttons --\x3e\n                <div class="flex gap-4">\n                    <button id="flip-coin" class="flex-1 bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all transform active:scale-[0.98] flex items-center justify-center gap-2 disabled:opacity-70 disabled:cursor-wait">\n                        <span class="text-xl">ü™ô</span>\n                        <span>Flip Coin</span>\n                    </button>\n                    \n                    <button id="clear-history" class="px-6 py-3 bg-white text-gray-600 border border-gray-200 hover:bg-gray-50 hover:border-gray-300 rounded-xl transition-all shadow-sm flex items-center gap-2">\n                        <span>üóëÔ∏è</span>\n                        <span class="hidden sm:inline">Clear</span>\n                    </button>\n                </div>\n            </div>\n            \n            \x3c!-- Error Message --\x3e\n            <div id="coin-error" class="hidden mt-6 p-4 bg-red-50 border border-red-100 rounded-xl text-red-600 text-sm flex items-center gap-3">\n                <span class="text-lg">‚ö†Ô∏è</span>\n                <span id="coin-error-message"></span>\n            </div>\n            \n            \x3c!-- Animation Stage --\x3e\n            <div class="relative mt-12 mb-8 min-h-[220px] flex flex-col items-center justify-center">\n                \x3c!-- Loading Indicator --\x3e\n                <div id="coin-loading" class="hidden absolute top-0 left-0 w-full h-full z-10 bg-white/50 backdrop-blur-sm flex items-center justify-center rounded-xl">\n                    <div class="flex flex-col items-center">\n                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600 mb-2"></div>\n                        <span class="text-sm font-medium text-emerald-800">Quantum flipping...</span>\n                    </div>\n                </div>\n\n                 \x3c!-- The Coin --\x3e\n                <div class="perspective-1000">\n                    <div id="animated-coin" class="w-40 h-40 relative transform-style-3d cursor-pointer transition-transform ease-out" style="transform: rotateY(0deg);">\n                        \x3c!-- Heads Face --\x3e\n                        <div class="absolute inset-0 w-full h-full rounded-full backface-hidden shadow-2xl border-4 border-yellow-300 bg-gradient-to-br from-yellow-400 via-yellow-500 to-yellow-600 flex items-center justify-center">\n                            <div class="text-center text-yellow-100 drop-shadow-md">\n                                <span class="text-5xl block mb-1">üëë</span>\n                                <span class="text-xs font-bold tracking-widest opacity-80">HEADS</span>\n                            </div>\n                        </div>\n                        \n                        \x3c!-- Tails Face --\x3e\n                        <div class="absolute inset-0 w-full h-full rounded-full backface-hidden shadow-2xl border-4 border-slate-300 bg-gradient-to-br from-slate-400 via-slate-500 to-slate-600 flex items-center justify-center rotate-y-180">\n                            <div class="text-center text-slate-100 drop-shadow-md">\n                                <span class="text-5xl block mb-1">ü¶Ö</span>\n                                <span class="text-xs font-bold tracking-widest opacity-80">TAILS</span>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                \x3c!-- Result Display --\x3e\n                <div id="current-result" class="mt-8 text-center h-12 transition-all duration-300 opacity-0 transform translate-y-2">\n                    <div class="text-3xl font-black tracking-tight" id="result-text">HEADS</div>\n                    <div class="text-xs text-gray-400 mt-1">Quantum Value: <span id="quantum-value" class="font-mono">--</span></div>\n                </div>\n            </div>\n            \n            \x3c!-- History Strip --\x3e\n            <div id="flip-history" class="mt-8 border-t border-gray-100 pt-6">\n                <div class="flex justify-between items-center mb-4">\n                    <h4 class="text-sm font-bold text-gray-700 uppercase tracking-wider">History <span id="history-stats" class="text-gray-400 font-normal normal-case ml-2"></span></h4>\n                    <button id="export-history" class="text-xs font-medium text-emerald-600 hover:text-emerald-700 hover:underline hidden">\n                        Export CSV\n                    </button>\n                </div>\n                \n                <div id="history-strip" class="flex gap-3 overflow-x-auto pb-4 scrollbar-hide">\n                    <div class="w-full text-center py-4 bg-gray-50 rounded-lg border border-dashed border-gray-200 text-gray-400 text-sm">\n                        No flips yet - give it a spin!\n                    </div>\n                </div>\n            </div>\n        </div>\n    ',this.bindEvents(),this.loadHistory()}bindEvents(){const t=this.container.querySelector("#flip-coin"),e=this.container.querySelector("#clear-history"),n=this.container.querySelector("#export-history"),s=this.container.querySelector("#coin-count");t.addEventListener("click",()=>this.flipCoin()),e.addEventListener("click",()=>this.clearHistory()),n.addEventListener("click",()=>this.exportStatistics()),s.addEventListener("keypress",t=>{"Enter"===t.key&&this.flipCoin()}),this.container.querySelector("#decrease-count").addEventListener("click",()=>{let t=parseInt(s.value)||0;t>1&&(s.value=t-1)}),this.container.querySelector("#increase-count").addEventListener("click",()=>{let t=parseInt(s.value)||0;t<20&&(s.value=t+1)})}async flipCoin(){const t=this.container.querySelector("#coin-count"),e=parseInt(t.value);if(this.container.querySelector("#coin-error").classList.add("hidden"),isNaN(e)||e<1||e>20)this.showError("Please enter a valid number of flips (1-20)");else{this.toggleLoading(!0);try{const t=await qrngService.getUint8(e);for(let n=0;n<e;n++){const s=t[n],i=s%2==0;await this.animateFlip(i,n===e-1,s),this.addToHistory({result:i?"heads":"tails",timestamp:new Date,quantumValue:s}),n<e-1&&await new Promise(t=>setTimeout(t,300))}this.updateHistoryDisplay(),window.qrngService&&qrngService.emit("tool_usage",{tool:"coinflip",count:e,results:t.map(t=>t%2==0?"heads":"tails")})}catch(t){console.error("Coin flip error:",t),this.showError(`Failed to flip coin: ${t.message}`)}finally{this.toggleLoading(!1)}}}async animateFlip(t,e=!0,n){const s=this.container.querySelector("#animated-coin"),i=this.container.querySelector("#current-result"),r=this.container.querySelector("#result-text"),o=this.container.querySelector("#quantum-value"),a={fast:600,normal:1200,slow:2e3}[this.container.querySelector("#coin-speed").value]||1200;i.classList.remove("opacity-100","translate-y-0"),i.classList.add("opacity-0","translate-y-2");const l=this.currentRotation;let d=l+1800;const c=l%360;let u=0;if(t?0!==c&&(u=180):0===c&&(u=180),d+=u,s.style.transitionDuration=`${a}ms`,s.style.transform=`rotateY(${d}deg)`,this.currentRotation=d,await new Promise(t=>setTimeout(t,a)),e){const e=t?"text-yellow-600":"text-slate-600";r.textContent=t?"HEADS":"TAILS",r.className=`text-3xl font-black tracking-tight ${e}`,o.textContent=n,i.classList.remove("opacity-0","translate-y-2"),i.classList.add("opacity-100","translate-y-0")}}addToHistory(t){this.history.unshift(t),this.history.length>this.maxHistory&&(this.history=this.history.slice(0,this.maxHistory)),this.saveHistory()}updateHistoryDisplay(){const t=this.container.querySelector("#history-strip"),e=this.container.querySelector("#history-stats"),n=this.container.querySelector("#export-history");if(0===this.history.length)return t.innerHTML='<div class="w-full text-center py-4 bg-gray-50 rounded-lg border border-dashed border-gray-200 text-gray-400 text-sm">No flips yet - give it a spin!</div>',e.textContent="",void n.classList.add("hidden");const s=this.history.filter(t=>"heads"===t.result).length,i=Math.round(s/this.history.length*100);e.textContent=`(${s}H / ${this.history.length-s}T - ${i}%)`,n.classList.remove("hidden"),t.innerHTML=this.history.map(t=>{const e="heads"===t.result,n=e?"üëë":"ü¶Ö";return`\n        <div class="flex flex-col items-center justify-center min-w-[60px] h-[70px] rounded-lg border ${e?"bg-yellow-100 border-yellow-200 text-yellow-700":"bg-slate-100 border-slate-200 text-slate-700"} p-1 transition-transform hover:scale-105" title="Quantum Value: ${t.quantumValue}">\n            <span class="text-xl mb-1">${n}</span>\n            <span class="text-xs font-bold uppercase">${t.result}</span>\n        </div>\n      `}).join("")}showError(t){const e=this.container.querySelector("#coin-error");this.container.querySelector("#coin-error-message").textContent=t,e.classList.remove("hidden")}toggleLoading(t){const e=this.container.querySelector("#flip-coin"),n=this.container.querySelector("#coin-loading");t?(e.disabled=!0,n.classList.remove("hidden")):(e.disabled=!1,n.classList.add("hidden"))}saveHistory(){try{localStorage.setItem("quantumCoinHistory",JSON.stringify(this.history))}catch(t){console.warn(t)}}loadHistory(){try{const t=localStorage.getItem("quantumCoinHistory");t&&(this.history=JSON.parse(t).map(t=>({...t,timestamp:new Date(t.timestamp)})),this.updateHistoryDisplay())}catch(t){console.warn(t)}}clearHistory(){this.history=[],this.saveHistory(),this.updateHistoryDisplay()}exportStatistics(){if(0===this.history.length)return;const t=this.history.filter(t=>"heads"===t.result).length,e=this.history.length-t,n=`Quantum Coin Flip Stats\nGenerated: ${(new Date).toLocaleString()}\n\nHeads: ${t}\nTails: ${e}\nTotal: ${this.history.length}\n\nHistory:\n${this.history.map((t,e)=>`${e+1}. ${t.result.toUpperCase()} (Val: ${t.quantumValue})`).join("\n")}`,s=new Blob([n],{type:"text/plain"}),i=URL.createObjectURL(s),r=document.createElement("a");r.href=i,r.download="quantum-coin-stats.txt",r.click(),URL.revokeObjectURL(i)}}window.QuantumCoinFlipTool=QuantumCoinFlipTool;